job_specifications:
- id: covid19modeljob
  max_wall_time: 11:00:00
  max_task_retries: 2
  recurrence:
    schedule:
      do_not_run_until: "2020-04-14T13:55:00Z"
      recurrence_interval: 1.00:00:00
  auto_complete: true
  job_preparation:
    command: docker pull fvalka/covid19model:latest
  tasks:
  - id: covid19runmodel
    docker_image: fvalka/covid19model:latest
    command: "Rscript web-fetch-and-run.r"
    environment_variables: 
      FULL: "TRUE"
    additional_docker_run_options:
    - -w /var/model
    - -v $(pwd)/figures:/var/model/figures
    - -v $(pwd)/results:/var/model/results
    - -v $(pwd)/web:/var/model/web
    output_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model
        is_file_share: true
        exclude:
        - ".shipyard.envlist"
        condition: tasksuccess
  - id: gitdeploy
    docker_image: fvalka/github-deploy:latest
    environment_variables:
      ACCESS_TOKEN: token
      REPO: ImperialCollegeLondon/covid19estimates
      BRANCH: data
    depends_on:
    - covid19runmodel
    command: wd/web/.
    input_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model/wd/web
        is_file_share: true
        exclude:
        - ".shipyard.envlist"

# Secondary run for verification purposes
- id: covid19modeljob-secondary
  max_wall_time: 11:00:00
  max_task_retries: 2
  recurrence:
    schedule:
      do_not_run_until: "2020-04-14T13:55:00Z"
      recurrence_interval: 1.00:00:00
  auto_complete: true
  job_preparation:
    command: docker pull fvalka/covid19model:latest
  tasks:
  - id: covid19runmodel-secondary
    docker_image: fvalka/covid19model:latest
    command: "Rscript web-fetch-and-run.r"
    environment_variables: 
      FULL: "TRUE"
    additional_docker_run_options:
    - -w /var/model
    - -v $(pwd)/figures:/var/model/figures
    - -v $(pwd)/results:/var/model/results
    - -v $(pwd)/web:/var/model/web
    output_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model-secondary
        is_file_share: true
        exclude:
        - ".shipyard.envlist"
        condition: tasksuccess
  - id: gitdeploy-secondary
    docker_image: fvalka/github-deploy:latest
    environment_variables:
      ACCESS_TOKEN: token
      REPO: ImperialCollegeLondon/covid19estimates
      BRANCH: data-secondary
    depends_on:
    - covid19runmodel-secondary
    command: wd/web/.
    input_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model-secondary/wd/web
        is_file_share: true
        exclude:
        - ".shipyard.envlist"

# Testing and debuging job
- id: covid19modeljob-testing
  max_wall_time: 11:00:00
  job_preparation:
    command: docker pull fvalka/covid19model:latest
  tasks:
  - id: covid19runmodel-testing
    docker_image: fvalka/covid19model:latest
    command: "Rscript web-fetch-and-run.r"
    environment_variables: 
      DEBUG: "TRUE"
    additional_docker_run_options:
    - -w /var/model
    - -v $(pwd)/figures:/var/model/figures
    - -v $(pwd)/results:/var/model/results
    - -v $(pwd)/web:/var/model/web
    output_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model-testing/current_web
        local_path: wd/web
        is_file_share: true
        exclude:
        - ".shipyard.envlist"
        condition: tasksuccess
      - storage_account_settings: resultstorage
        remote_path: covid19model-testing/v2/$(date -Iminutes)
        is_file_share: true
        exclude:
        - ".shipyard.envlist"
        condition: tasksuccess
  - id: gitdeploy-testing
    docker_image: fvalka/github-deploy:latest
    environment_variables:
      ACCESS_TOKEN: <GitHub access token>
      REPO: ImperialCollegeLondon/covid19estimates
      BRANCH: data-testing
    depends_on:
    - covid19runmodel-testing
    command: current_web/.
    input_data:
      azure_storage:
      - storage_account_settings: resultstorage
        remote_path: covid19model-testing/current_web
        is_file_share: true
        exclude:
        - ".shipyard.envlist"
